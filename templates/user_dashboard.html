{% extends "base.html" %}

{% block title %}My Appointments | MediCare{% endblock %}

{% block content %}
<div class="container-fluid py-4">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="fw-bold mb-0 text-primary">My Appointments</h3>
    <div>
      <span class="text-muted me-3">Welcome, <strong>{{ session.full_name or session.username }}</strong></span>
      <a href="{{ url_for('logout') }}" class="btn btn-outline-danger btn-sm">Logout</a>
    </div>
  </div>

  <!-- Appointments List -->
  {% if appointments %}
  <div class="card border-0 shadow-sm mb-5">
    <div class="card-header bg-light fw-semibold text-primary">Your Appointments</div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>Doctor</th>
              <th>Specialization</th>
              <th>Date</th>
              <th>Time</th>
              <th>Reason</th>
              <th>Status</th>
              <th class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for appointment in appointments %}
            <tr>
              <td>
                  <strong class="text-primary">
                      {{ appointment.doctor_name or 'Dr. Unknown' }}
                  </strong>
              </td>
              <td>{{ appointment.specialization or '—' }}</td>
              <td>{{ appointment.appointment_date }}</td>
              <td>{{ appointment.start_time or appointment.appointment_time }}</td>
              <td>{{ appointment.reason or '—' }}</td>
              <td>
                <span class="badge 
                  {% if appointment.status == 'Pending' %}bg-warning text-dark
                  {% elif appointment.status == 'Confirmed' %}bg-success
                  {% elif appointment.status == 'Cancelled' %}bg-secondary
                  {% else %}bg-primary{% endif %}">
                  {{ appointment.status }}
                </span>
              </td>
              <td class="text-end">
                {% if appointment.status in ['Pending','Confirmed'] and appointment.appointment_date >= today %}
                <a href="{{ url_for('cancel_appointment', appointment_id=appointment.appointment_id) }}" class="btn btn-sm btn-outline-danger">Cancel</a>
                {% else %}
                <a href="{{ url_for('view_appointment', appointment_id=appointment.appointment_id) }}" 
                  class="btn btn-sm btn-outline-primary">
                  <i class="bi bi-eye"></i> View
                </a>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% else %}
  <div class="alert alert-info shadow-sm">
    You don’t have any appointments yet. Book your first appointment below!
  </div>
  {% endif %}

  <!-- Booking Form (NO JS) -->
  <div class="card shadow-sm border-0 mt-4">
    <div class="card-header bg-light text-primary fw-semibold">Book New Appointment</div>
    <div class="card-body">

      <!-- Step 1: Select Doctor & Date → Auto Submit to Load Times -->
      <form method="GET" action="{{ url_for('user_dashboard') }}" id="load-times-form">
        <div class="row g-3 align-items-end mb-4">
          <div class="col-md-6">
            <label class="form-label fw-semibold">Select Doctor</label>
            <select name="doctor_id" class="form-select" onchange="this.form.submit()">
              <option value="">Choose a doctor</option>
              {% for doctor in doctors %}
              <option value="{{ doctor.doctor_id }}" 
                  {% if request.args.doctor_id == doctor.doctor_id|string %}selected{% endif %}>
                  {{ doctor.display_name }} — {{ doctor.specialization or 'General' }}
              </option>
              {% endfor %} 
            </select>
          </div>

          <div class="col-md-3">
            <label class="form-label fw-semibold">Date</label>
            <input type="date" name="appointment_date" class="form-control" min="{{ today }}" 
                   value="{{ request.args.appointment_date }}" onchange="this.form.submit()" required>
          </div>

          <div class="col-md-3">
            <button type="submit" class="btn btn-outline-primary w-100">Load Available Times</button>
          </div>
        </div>
      </form>

      <!-- Step 2: Show Available Times (Server-Rendered) -->
      {% if selected_doctor and selected_date and available_slots is defined %}
      <div class="alert alert-success">
        Available times for <strong>{{ selected_doctor.display_name or 'Selected Doctor' }}</strong>
      </div>

      <form action="{{ url_for('book_appointment') }}" method="POST">
        <input type="hidden" name="doctor_id" value="{{ selected_doctor.doctor_id }}">
        <input type="hidden" name="appointment_date" value="{{ selected_date }}">

        <div class="row g-3 mb-3">
          <div class="col-md-4">
            <label class="form-label fw-semibold">Choose Time</label>
            <select name="start_time" class="form-select" required>
              <option value="">Select time</option>
              {% for slot in available_slots %}
              <option value="{{ slot }}">{{ slot }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label fw-semibold">Reason for Visit</label>
          <textarea name="reason" rows="3" class="form-control" placeholder="Brief description..." required></textarea>
        </div>

        <div class="d-grid">
          <button type="submit" class="btn btn-primary">Confirm Booking</button>
        </div>
      </form>

      {% elif request.args.doctor_id and request.args.appointment_date %}
      <div class="alert alert-warning">
        No available time slots for the selected doctor and date.
      </div>
      {% endif %}

      <!-- Show selected doctor name -->
      {% if selected_doctor %}
      <div class="mt-4 p-3 bg-light border rounded">
        <h6 class="text-primary mb-1">Selected Doctor</h6>
        <p class="fw-bold text-dark mb-0">
    <p class="fw-bold text-dark mb-0">
        {{ selected_doctor.display_name or 'Dr. Not Found' }} 
        — {{ selected_doctor.specialization or 'General' }}
    </p>
      </p>
      </div>
      {% endif %}

    </div>
  </div>
</div>
{% endblock %}